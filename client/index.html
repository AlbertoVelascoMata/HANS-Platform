<!DOCTYPE html>
<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    </head>
    <body>
        <h1>
            Swarm Platform (dev)
        </h1>
        <div style="padding:10px; border: 1px solid black;">
            <h3>
                Server endpoint
            </h3>
            <label for="server-host">Server:</label>
            <input id="server-host" name="server-host" type="text" value="localhost" required>
            <br>
            <label for="server-api-port">API port:</label>
            <input id="server-api-port" name="server-api-port" type="text" value="5000" required>
            <br>
            <label for="server-mqtt-port">MQTT port:</label>
            <input id="server-mqtt-port" name="server-mqtt-port" type="text" value="1883" required>
        </div>
        <div>
            <h3>
                Session
            </h3>
            <form id="session-form">
                <label for="session-id">Session:</label>
                <input id="session-id" name="session-id" type="text" required>
                <button id="session-get-btn" type="submit">Get details</button>
            </form>
            <span>Details:</span>
            <span id="session-details"></span>
        </div>
        <div>
            <h3>
                Question
            </h3>
            <form id="question-form">
                <label for="question-id">Question:</label>
                <input id="question-id" name="question-id" type="text" required>
                <button id="question-get-btn" type="submit">Get details</button>
            </form>
            <span>Details:</span>
            <span id="question-details"></span>
            <br>
            <span>Image:</span>
            <img id="question-img">
        </div>
        <div>
            <h3>
                MQTT
            </h3>
            <button id="mqtt-connect-btn" type="submit">Connect</button>
            <button id='mqtt-send-msg'>Send MQTT message></button>
            <button onclick="client.close()">Disconnect</button>
        </div>

        <script type="text/javascript">
            class MqttHelper {
                connect(hostname) {
                    const url = 'ws://' + hostname + ':1883/';
                    const options = {
                        clean: true,
                        connectTimeout: 4000,
                    };
                    this.client = mqtt.connect(url, options);
                    this.client.on('connect', () => {
                        console.log('[MQTT] Client connected to broker (' + url + ')');
                        this.client.subscribe('swarm/session/#', (err) => {
                            if(!err) console.log("[MQTT] Subscribed to /swarm/session/#");
                        });
                    });
                    this.client.on('message', (topic, message) => {
                        let data = JSON.parse(message.toString());
                        if(data.id != CLIENT_ID)
                        console.log("[MQTT] Received: " + JSON.stringify(data));
                    });
                }
                publish(message) {
                    this.client.publish('swarm/session/1', message);
                }
                close() {
                    this.client.end();
                }
            }
            var client = new MqttHelper();
            const CLIENT_ID = Math.floor(Math.random() * 1000000);

            $(document).ready(() => {
                $('#session-form').submit(event => {
                    event.preventDefault();
                    fetch(`http://${$('#server-host').val()}:${$('#server-api-port').val()}/api/session/${$('#session-id').val()}`, {
                        method: 'GET'
                    }).then(res => {
                        if(res.status == 200) {
                            res.json().then(data => {
                                $('#session-details').html(JSON.stringify(data));
                                $('#question-id').attr('value', data.question);
                            });
                        } else {
                            res.text().then(data => {
                                $('#session-details').html(`ERROR (${res.status}): ${data}`);
                            });
                        }
                    }).catch(res => {
                        $('#session-details').html(`ERROR: ${res}`);
                    })
                });
                $('#question-form').submit(event => {
                    event.preventDefault();
                    $('#question-img').attr('src', `http://${$('#server-host').val()}:${$('#server-api-port').val()}/api/question/${$('#question-id').val()}/image`);
                    fetch(`http://${$('#server-host').val()}:${$('#server-api-port').val()}/api/question/${$('#question-id').val()}`, {
                        method: 'GET'
                    }).then(res => {
                        if(res.status == 200) {
                            res.json().then(data => {
                                $('#question-details').html(JSON.stringify(data));
                            });
                        } else {
                            res.text().then(data => {
                                $('#question-details').html(`ERROR (${res.status}): ${data}`);
                            });
                        }
                    }).catch(res => {
                        $('#question-details').html(`ERROR: ${res}`);
                    })
                });
                $('#mqtt-connect-btn').on('click', () => {
                    client.connect($('#server-host').val());
                });

                $('#mqtt-send-msg').on('click', () => {
                    client.publish(JSON.stringify({'id': CLIENT_ID, 'data': {'position': [0, 0]}}))
                });
            });
        </script>
    </body>
</html>
